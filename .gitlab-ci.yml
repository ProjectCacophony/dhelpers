image: golang:1.10

stages:
  - test

before_script:
  # create symlink to ${CI_PROJECT_DIR} in ${GOPATH} and cd there
  - mkdir -p ${GOPATH}/src/gitlab.com/${CI_PROJECT_NAMESPACE}
  - cd ${GOPATH}/src/gitlab.com/${CI_PROJECT_NAMESPACE}
  - ln -s ${CI_PROJECT_DIR}
  - cd ${CI_PROJECT_NAME}
  # install dependencies
  - go get -v ./...
  - go get -v golang.org/x/tools/cmd/goimports
  - go get -v gopkg.in/alecthomas/gometalinter.v2
  - gometalinter.v2 --install

testing:
  stage: test
  script:
    - diff <(goimports -d .) <(echo -n)
    - go test -v -race ./...
    - gometalinter.v2 ./... --deadline 5m
